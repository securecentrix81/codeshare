<!DOCTYPE html>
<html>
    <head>
        
    </head>
    <body>
        <textarea id="textareaInput"></textarea><button id="compressBtn">Compress</button>
        <div id="overlay" style="width:100%;height:100%;position:fixed;top:0;left:0;background-color:#ffffff;display:flex;justify-content:center;align-items:center;font-size:9vmin">Loading...</div>
        <script>addEventListener("error",(e)=>{alert(e.message+e.lineno)})</script>
        <script>
        async function compressText(input) {
          if (!input) {
            alert('Nothing to compress');
            return;
          }
        
          try { 
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
        
            const stream = new ReadableStream({
              start(controller) {
                controller.enqueue(data);
                controller.close();
              }
            }).pipeThrough(new CompressionStream('gzip'));
        
            const compressed = await new Response(stream).arrayBuffer();
            return String.fromCharCode(...new Uint8Array(compressed))
            /*
            const base64 = btoa();
        
            return base64;*/
          } catch (e) {
            alert('Compression failed: ' + e.message);
          }
        }
        
        async function decompressText(input) {
          if (!input) {
            alert('Nothing to decompress');
            return;
          }
        
          try {
            const binary = input//atob(input);
            const data = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) data[i] = binary.charCodeAt(i);
         
            const stream = new ReadableStream({
              start(controller) {
                controller.enqueue(data);
                controller.close();
              } 
            }).pipeThrough(new DecompressionStream('gzip'));
        
            const decompressed = await new Response(stream).text();
        
            return decompressed;
          } catch (e) {
            alert('Decompression failed â€“ is the string valid gzip+base64?\n\n' + e.message);
          }
        } 
        
        let parameters = new URLSearchParams(document.location.search);
        let data = parameters.get("data");
        
        let textareaInput = document.getElementById("textareaInput");
        (async function(){
            try {
                if (data) {
                    let decompress = await decompressText(data);
                    if (parameters.get("analyze")) {
                        let pre = document.createElement("pre")
                        pre.innerText = decompress
                        document.documentElement.innerText = ""
                        document.documentElement.appendChild(pre)
                    } else {
                        document.open()
                        document.write(decompress);
                        document.close()
                    }
                } else {
                    document.getElementById("compressBtn").addEventListener("click", async function() {
                        try {
                            let compress = await compressText(textareaInput.value);
                            location.search = "?data=" + encodeURIComponent(compress);
                        } catch (e) {
                            alert(e);
                        }
                    });
                    document.getElementById("overlay").remove();
                }
            } catch (e) {
                alert(e);
            }
        })();
        </script>
    </body>
</html>
